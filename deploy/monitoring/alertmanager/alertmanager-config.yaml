apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-config
  namespace: campaign-express
  labels:
    app: alertmanager
    app.kubernetes.io/part-of: campaign-express
data:
  alertmanager.yml: |
    global:
      resolve_timeout: 5m
      smtp_smarthost: 'smtp.example.com:587'
      smtp_from: 'alertmanager@campaign-express.io'
      smtp_auth_username: 'alertmanager@campaign-express.io'
      smtp_auth_password: '<SMTP_PASSWORD>'
      smtp_require_tls: true

    route:
      group_by: ['alertname', 'namespace']
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 4h
      receiver: ops-team
      routes:
        - match:
            severity: critical
          receiver: pagerduty
        - match:
            severity: warning
          receiver: ops-team

    receivers:
      - name: ops-team
        email_configs:
          - to: 'ops-team@campaign-express.io'
            send_resolved: true
        slack_configs:
          - api_url: '<SLACK_WEBHOOK_URL>'
            channel: '#campaign-express-alerts'
            send_resolved: true
            title: '{{ template "slack.default.title" . }}'
            text: '{{ template "slack.default.text" . }}'

      - name: pagerduty
        pagerduty_configs:
          - service_key: '<PAGERDUTY_SERVICE_KEY>'
            send_resolved: true

    inhibit_rules:
      - source_match:
          severity: critical
        target_match:
          severity: warning
        equal: ['alertname']
