#---------------------------------------------------------------------
# Campaign Express â€” HAProxy Ingress Load Balancer
#---------------------------------------------------------------------
# Distributes incoming bid requests across Campaign Express pods.
# Optimized for high-throughput, low-latency ad serving.
#---------------------------------------------------------------------

global
    maxconn 100000
    nbthread 4
    log stdout format raw local0
    stats socket /var/run/haproxy.sock mode 660 level admin
    tune.ssl.default-dh-param 2048

defaults
    mode http
    log global
    option httplog
    option dontlognull
    option http-server-close
    option forwardfor except 127.0.0.0/8
    timeout connect 2s
    timeout client  5s
    timeout server  5s
    timeout http-request 5s
    timeout http-keep-alive 2s
    timeout queue 5s
    retries 2
    default-server inter 3s fall 3 rise 2

#---------------------------------------------------------------------
# Frontend: HTTP bid requests
#---------------------------------------------------------------------
frontend ft_http
    bind *:80
    bind *:443 ssl crt /etc/haproxy/certs/campaign-express.pem alpn h2,http/1.1

    # Rate limiting
    stick-table type ip size 1m expire 30s store http_req_rate(10s)
    http-request track-sc0 src
    http-request deny deny_status 429 if { sc_http_req_rate(0) gt 10000 }

    # Route bid requests
    acl is_bid path_beg /v1/bid
    acl is_health path /health /ready /live
    acl is_metrics path /metrics

    use_backend bk_campaign_express if is_bid
    use_backend bk_health if is_health
    use_backend bk_campaign_express if is_metrics

    default_backend bk_campaign_express

#---------------------------------------------------------------------
# Frontend: gRPC bid requests
#---------------------------------------------------------------------
frontend ft_grpc
    bind *:9090 proto h2
    default_backend bk_grpc

#---------------------------------------------------------------------
# Backend: Campaign Express HTTP pods
#---------------------------------------------------------------------
backend bk_campaign_express
    balance leastconn
    option httpchk GET /ready
    http-check expect status 200

    # Dynamic server resolution via DNS (K8s headless service)
    server-template campaign-express 20 campaign-express-headless.campaign-express.svc.cluster.local:8080 check resolvers dns init-addr none

#---------------------------------------------------------------------
# Backend: Campaign Express gRPC pods
#---------------------------------------------------------------------
backend bk_grpc
    balance roundrobin
    server-template campaign-express-grpc 20 campaign-express-headless.campaign-express.svc.cluster.local:9090 check resolvers dns init-addr none proto h2

#---------------------------------------------------------------------
# Backend: Health checks (all pods)
#---------------------------------------------------------------------
backend bk_health
    balance roundrobin
    option httpchk GET /health
    server-template health 20 campaign-express-headless.campaign-express.svc.cluster.local:8080 check resolvers dns init-addr none

#---------------------------------------------------------------------
# DNS resolvers for K8s service discovery
#---------------------------------------------------------------------
resolvers dns
    nameserver kube-dns 10.96.0.10:53
    accepted_payload_size 8192
    resolve_retries 3
    timeout resolve 1s
    timeout retry 1s
    hold valid 5s

#---------------------------------------------------------------------
# Stats / monitoring endpoint
#---------------------------------------------------------------------
frontend stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 10s
    stats admin if LOCALHOST
